@inject AuthService AuthService
@inject ApiService ApiService

<div class="comment-form">
    <textarea @bind="content" @onkeypress="HandleKeyPress"              placeholder="Add a comment..."              disabled="@isLoading"              rows="2"
              maxlength="1000"></textarea>

    @if (!string.IsNullOrEmpty(error))
    {
        <p style="color: #ff4757; font-size: 12px; margin-bottom: 10px;">@error</p>
    }

    <div class="form-actions">
        <button @onclick="HandleSubmit"                class="submit-comment-btn"
                disabled="@(isLoading || string.IsNullOrWhiteSpace(content))">
            @(isLoading ? "Posting..." : "Post Comment")
        </button>
    </div>
</div>

@code {
    [Parameter] public string PostId { get; set; } = string.Empty;
    [Parameter] public EventCallback OnCommentAdded { get; set; }

    private string content = "";
    private bool isLoading = false;
    private string error = "";

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !isLoading && !string.IsNullOrWhiteSpace(content))
        {
            await HandleSubmit();
        }
    }

    private async Task HandleSubmit()
    {
        var trimmedContent = content.Trim();

        if (string.IsNullOrEmpty(trimmedContent))
        {
            error = "Please enter a comment.";
            return;
        }

        isLoading = true;
        error = "";
        StateHasChanged();

        try
        {
            var user = AuthService.AuthState.User;
            if (user == null) throw new InvalidOperationException("User not authenticated");

            await ApiService.CreateCommentAsync(PostId, trimmedContent, user.Username);
            content = "";
            await OnCommentAdded.InvokeAsync();
        }
        catch (Exception ex)
        {
            error = "An error occurred while posting your comment.";
            Console.WriteLine($"Error creating comment: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}