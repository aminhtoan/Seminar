@using Contoso.BlazorApp.Models
@using Contoso.BlazorApp.Services
@inject AuthService AuthService
@inject ApiService ApiService
@inject IJSRuntime JSRuntime

<div class="comment-item">
    <div class="comment-header">
        <span class="comment-user">@@@Comment.Username</span>
        <span class="comment-time">@Comment.CreatedAt.ToLocalTime().ToShortDateString()</span>
    </div>

    @if (isEditing)
    {
        <div style="margin-top: 10px;">
            <textarea @bind="editContent"
                      style="width: 100%; padding: 10px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; resize: vertical; min-height: 60px;"
                      rows="3"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                <button @onclick="HandleSaveEdit"                        class="submit-btn" style="padding: 8px 16px; font-size: 14px;">
                    Save
                </button>
                <button @onclick="HandleCancelEdit"                        class="cancel-btn" style="padding: 8px 16px; font-size: 14px;">
                    Cancel
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="comment-content">@Comment.Content</div>
        @if (isAuthor)
        {
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button @onclick="HandleEditClick"                        class="action-btn edit-btn" style="font-size: 12px;">
                    ‚úèÔ∏è Edit
                </button>
                <button @onclick="HandleDeleteClick"                        class="action-btn delete-btn" style="font-size: 12px;">
                    üóëÔ∏è Delete
                </button>
            </div>
        }
    }
</div>

@code {
    [Parameter] public Comment Comment { get; set; } = new();
    [Parameter] public string PostId { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> OnCommentDelete { get; set; }
    [Parameter] public EventCallback<Comment> OnCommentUpdate { get; set; }

    private bool isEditing = false;
    private string editContent = string.Empty;
    private bool isAuthor = false;

    protected override void OnInitialized()
    {
        editContent = Comment.Content;
        isAuthor = AuthService.AuthState.User != null && AuthService.AuthState.User.Username == Comment.Username;
    }

    private void HandleEditClick()
    {
        isEditing = true;
        editContent = Comment.Content;
    }

    private void HandleCancelEdit()
    {
        isEditing = false;
        editContent = Comment.Content;
    }

    private async Task HandleSaveEdit()
    {
        if (string.IsNullOrWhiteSpace(editContent) || AuthService.AuthState.User == null) return;

        try
        {
            await ApiService.UpdateCommentAsync(PostId, Comment.Id, editContent, AuthService.AuthState.User.Username);
            Comment.Content = editContent;
            await OnCommentUpdate.InvokeAsync(Comment);
            isEditing = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating comment: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "An error occurred while updating the comment.");
        }
    }

    private async Task HandleDeleteClick()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this comment?");
        if (!confirmed) return;

        try
        {
            await ApiService.DeleteCommentAsync(PostId, Comment.Id);
            await OnCommentDelete.InvokeAsync(Comment.Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting comment: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "An error occurred while deleting the comment.");
        }
    }
}